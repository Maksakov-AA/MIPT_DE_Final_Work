# MIPT_DE_Final_Work
Экзаменационная работа МФТИ по предмету Инжиниринг данных

## Тема
Автоматизация и оркестрация пайплайна машинного обучения с использованием Apache Airflow и облачного хранилища.

## Описание задания
Вы инженер данных в медицинском центре, где разрабатываются предиктивные модели диагностики заболеваний. Ваша задача — спроектировать и реализовать автоматизированный ETL-процесс: от получения медицинских данных до выгрузки результатов модели в облачное хранилище с помощью Apache Airflow и Python. 

Результат работы: воспроизводимый проект в виде репозитория с пояснениями в формате README.


# Проект: Автоматизация ML-пайплайна с использованием Apache Airflow

## Цель проекта
Разработать воспроизводимый и надёжный ML-процесс с полной оркестрацией с помощью Apache Airflow, а также обеспечить автоматическое выполнение задач по обучению модели, её оценке и выгрузке результатов в облачное хранилище Google Drive.

## Архитектура проекта
Проект реализован в виде пайплайна, включающего 5 основных шагов:
- Загрузка и разбиение данных - Скрипт load_data.py загружает исходный датасет (wdbc_data.csv), делит его на обучающую и тестовую выборки, и сохраняет в data/train.csv и data/test.csv. Это исходная точка всего процесса
- Предобработка данных - Скрипт preprocessing.py применяет стандартизацию признаков, обработку пропущенных значений (если есть) и кодирование категориальных переменных. Обработанные данные сохраняются в data/processed/
- Обучение модели - Скрипт train_model.py обучает модель классификации (например, логистическую регрессию или RandomForest) на предварительно обработанных данных. Результирующая модель сохраняется в models/model.pkl
- Оценка модели - Скрипт evaluate.py применяет обученную модель к тестовой выборке, рассчитывает метрики качества (accuracy, precision, recall, f1-score) и сохраняет их в results/metrics.json
- Выгрузка метрик и модели на Google Drive - Скрипт upload_to_drive.py авторизуется через сервисный аккаунт (используя credentials.json) и загружает файл с метриками (metrics.json) и/или модель на указанный Google Drive

Все шаги представлены в отдельных модулях Python и объединены в DAG Airflow с названием ml_pipeline_dag.

## Схема пайплайна
![alt text](https://github.com/Maksakov-AA/MIPT_DE_Final_Work/blob/main/images/pipeline_scheme.png?raw=true)

## Структура проекта с описанием скриптов 
ml_pipeline_project/ - корневая директория
│
├── dags/ - директория для DAG файлов
│   ├── pipeline_dag.py - DAG-файл для Apache Airflow
├── etl/ - директория для шагов обработки и моделирования
│   ├── load_data.py - загружает исходные данные из CSV-файлов. Делит на тренировочную и тестовую выборки, копирует их в папку
│   ├── preprocessing.py - выполняет очистку, кодирование категориальных признаков и масштабирование числовых. Обрабатывает данные для последующего обучения модели
│   ├── train_model.py - обучает модель (например, RandomForest или другую) на обработанных тренировочных данных и сохраняет результат в models/model.pkl
│   └── evaluate.py - выполняет прогноз на тестовых данных и рассчитывает метрики (accuracy, f1-score и др.). Сохраняет результат в results/metrics.json
├── scripts/upload_to_drive.py - Скрипт, который загружает финальные результаты (metrics.json) на Google Drive с использованием сервисного аккаунта и credentials.json
├── data/ - директория для хранения оригинальных датасетов
│   ├── train.csv - тренировочная выборка
│   ├── test.csv - тестовая выборка
├── data/processed/ - директория для хранения обработанных датасетов (после preprocessing.py)
│   ├── train.csv - обработанная тренировочная выборка
│   ├── test.csv - обработанная тестовая выборка
├── models/ - директория для хранения моделей
│   ├── model.pkl - модель, обученная в train_model.py, готовая к использованию или деплою
├── results/ - итоговые файлы
│   ├── /metrics.json - файл с метриками качества модели, сформированный в evaluate.py. Используется для отчётности или мониторинга
├── credentials - креды
│   ├── /credentials.json - ключ сервисного аккаунта Google. Используется в upload_to_drive.py для авторизации при загрузке файлов на Google Drive
├── logs/ - папка для логов, создаётся автоматически Airflow. Используется для хранения логов исполнения задач DAG
├── venv/ - виртуальное окружение Python с установленными зависимостями (pandas, scikit-learn, google-api-python-client и т. д.). Используется для изоляции среды.
└── README.md - описание

## Инструкция по запуску
1. Установка  зависимости:

pip install -r requirements.txt

Установите и настройте Airflow:

export AIRFLOW_HOME=~/ml_pipeline_project/airflow
airflow db init

Создайте пользователя (один раз):

airflow users create \
    --username admin \
    --firstname admin \
    --lastname admin \
    --role Admin \
    --email admin@example.com \
    --password admin

Запустите:

airflow webserver --port 8080
airflow scheduler

Для ручного запуска:

## Интеграция с Google Drive
Файл upload_to_drive.py использует credentials/credentials.json, полученный через Google Cloud Console (OAuth сервисный аккаунт).
- Загружаются два файла: модель и метрики
- Указан folder_id целевой папки

## Надёжность и устойчивость
- Каждый модуль обособлен и логирует ключевые действия
- Airflow retries=2, retry_delay=timedelta(minutes=1) предусмотрены
- При ошибке в одном шаге — DAG останавливается, но шаги изолированы логически

## Потенциальные точки сбоя
- API Google может быть недоступен → предусмотрен retry
- Невалидные данные → предусмотрены проверки на NaN, сохранение промежуточных файлов
- Ошибки модели → try-except блок в train_model.py

## Предложения по развитию
- Добавить Telegram-уведомления о статусе DAG
- Добавить профилирование модели и логирование метрик в MLflow
- Реализовать CI/CD (например, через GitHub Actions)

## Скриншоты работы DAG
![alt text]([http://url/to/img.png](https://github.com/Maksakov-AA/MIPT_DE_Final_Work/blob/main/images/AirFlow_DAG.png))
![alt text]([http://url/to/img.png](https://github.com/Maksakov-AA/MIPT_DE_Final_Work/blob/main/images/AirFlow_DAG_2.png))

## Ссылки
- http://194.87.252.54:8080/dags/ml_pipeline_dag/grid - Ссылка на AirFlow
- https://drive.google.com/drive/folders/1X6MaMZe-YRXfSBLTQuOUia9QkulA4iem - Папка с model.pkl на Google Drive
